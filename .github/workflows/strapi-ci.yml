name: Strapi CI (build -> push -> PR bump GitOps)

on:
  push:
    branches: [ "main" ]
    paths:
      - "strapi/**"
      - ".github/workflows/strapi-ci.yml"
  workflow_dispatch: {}

permissions:
  contents: write
  pull-requests: write
  packages: write

concurrency:
  group: strapi-ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build_scan_push_and_pr:
    runs-on: ubuntu-latest
    # avoid running again on the PR-commit that only changes GitOps (and is made by the bot)
    if: github.actor != 'github-actions[bot]'

    env:
      IMAGE: ghcr.io/${{ github.repository_owner }}/strapi
      PROD_FILE: gitops/apps/strapi/chart/values.yaml
      DEV_FILE:  gitops/apps/strapi-dev/chart/values.yaml

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install deps
        working-directory: strapi
        run: npm ci

      - name: Build Strapi admin
        working-directory: strapi
        run: npm run build

      - uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Use full SHA (best for immutable GitOps)
      - name: Compute tag (commit SHA)
        id: tag
        run: echo "t=${GITHUB_SHA}" >> "$GITHUB_OUTPUT"

      - name: Build and push (immutable tag only)
        uses: docker/build-push-action@v6
        with:
          context: ./strapi
          file: ./strapi/Dockerfile
          push: true
          tags: |
            ${{ env.IMAGE }}:${{ steps.tag.outputs.t }}

      - name: Trivy scan (HIGH/CRITICAL)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ env.IMAGE }}:${{ steps.tag.outputs.t }}
          format: table
          severity: HIGH,CRITICAL
          ignore-unfixed: true
          exit-code: "0"

      - name: Bump Helm values.yaml image.tag to SHA (prod + dev)
        run: |
          set -euo pipefail
          SHA="${{ steps.tag.outputs.t }}"

          bump_file () {
            local FILE="$1"
            if [ ! -f "$FILE" ]; then
              echo "ℹ️ Skipping missing file: $FILE"
              return 0
            fi

            echo "Updating $FILE -> tag: $SHA"

            python3 - <<'PY'
          import os
          path = os.environ["FILE"]
          sha  = os.environ["SHA"]

          lines = open(path, "r", encoding="utf-8").read().splitlines(True)

          out = []
          in_image = False
          image_indent = None
          replaced = False

          for line in lines:
              if not in_image and line.lstrip().startswith("image:"):
                  in_image = True
                  image_indent = len(line) - len(line.lstrip())
                  out.append(line)
                  continue

              if in_image:
                  cur_indent = len(line) - len(line.lstrip())
                  # exit image block on next top-level key
                  if line.strip() and cur_indent <= image_indent and not line.lstrip().startswith(("#", "-")):
                      in_image = False

              if in_image and line.lstrip().startswith("tag:"):
                  indent = line[:len(line) - len(line.lstrip())]
                  out.append(f'{indent}tag: "{sha}"\n')
                  replaced = True
              else:
                  out.append(line)

          if not replaced:
              raise SystemExit(f"Did not find image.tag to replace in {path}")

          open(path, "w", encoding="utf-8").write("".join(out))
          PY
          }

          bump_file "${PROD_FILE}"
          bump_file "${DEV_FILE}"
        env:
          SHA: ${{ steps.tag.outputs.t }}
          PROD_FILE: ${{ env.PROD_FILE }}
          DEV_FILE: ${{ env.DEV_FILE }}

      - name: Create PR for GitOps bump (prod + dev)
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ci/strapi-bump-${{ steps.tag.outputs.t }}
          delete-branch: true
          base: main
          commit-message: "chore(strapi): bump image tag to ${{ steps.tag.outputs.t }} (prod+dev)"
          title: "chore(strapi): bump image tag to ${{ steps.tag.outputs.t }} (prod+dev)"
          body: |
            This PR updates Strapi GitOps source-of-truth to the new immutable image tag.

            - Image: `${{ env.IMAGE }}:${{ steps.tag.outputs.t }}`
            - Prod: `${{ env.PROD_FILE }}`
            - Dev: `${{ env.DEV_FILE }}`

            Merge -> ArgoCD auto-sync -> rollout.

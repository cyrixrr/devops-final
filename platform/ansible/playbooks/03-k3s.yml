---
- name: Install k3s server on dell-optiplex-1
  hosts: server
  become: true
  vars:
    k3s_version: "v1.30.6+k3s1"
    k3s_server_ip: "192.168.0.100"
  tasks:
    - name: Install k3s server (pinned version)
      ansible.builtin.shell: |
        curl -sfL https://get.k3s.io | \
        INSTALL_K3S_VERSION={{ k3s_version }} \
        sh -s - server \
          --write-kubeconfig-mode 644 \
          --node-ip {{ k3s_server_ip }} \
          --tls-san {{ k3s_server_ip }}
      args:
        creates: /usr/local/bin/k3s

    - name: Ensure k3s service is running
      ansible.builtin.service:
        name: k3s
        state: started
        enabled: true

    - name: Read node token
      ansible.builtin.slurp:
        src: /var/lib/rancher/k3s/server/node-token
      register: node_token

    - name: Set join token fact
      ansible.builtin.set_fact:
        k3s_join_token: "{{ node_token.content | b64decode | trim }}"

- name: Install k3s agents on hp-prodesk nodes
  hosts: agents
  become: true
  vars:
    k3s_version: "v1.30.6+k3s1"
    k3s_server_url: "https://192.168.0.100:6443"
  tasks:
    - name: Install k3s agent (pinned version)
      ansible.builtin.shell: |
        curl -sfL https://get.k3s.io | \
        INSTALL_K3S_VERSION={{ k3s_version }} \
        K3S_URL={{ k3s_server_url }} \
        K3S_TOKEN={{ hostvars[groups['server'][0]].k3s_join_token }} \
        sh -
      args:
        creates: /usr/local/bin/k3s-agent

    - name: Ensure k3s-agent service is running
      ansible.builtin.service:
        name: k3s-agent
        state: started
        enabled: true

- name: Fetch kubeconfig to control workstation
  hosts: server
  tasks:
    - name: Fetch kubeconfig (requires sudo on the server)
      become: true
      ansible.builtin.fetch:
        src: /etc/rancher/k3s/k3s.yaml
        dest: ./kubeconfig/k3s.yaml
        flat: true

    - name: Replace localhost with server IP in fetched kubeconfig (no sudo on localhost)
      delegate_to: localhost
      become: false
      ansible.builtin.replace:
        path: ./kubeconfig/k3s.yaml
        regexp: '127\.0\.0\.1'
        replace: '192.168.0.100'

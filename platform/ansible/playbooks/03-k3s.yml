---
- name: Install/ensure k3s server (control-plane)
  hosts: server
  become: true
  gather_facts: true

  vars:
    k3s_version: "v1.30.6+k3s1"
    k3s_install_script: /usr/local/src/k3s-install.sh

  tasks:
    - name: Ensure install script directory exists
      ansible.builtin.file:
        path: /usr/local/src
        state: directory
        mode: "0755"

    - name: Download k3s install script (no curl|sh)
      ansible.builtin.get_url:
        url: https://get.k3s.io
        dest: "{{ k3s_install_script }}"
        mode: "0755"

    - name: Check if k3s server service exists
      ansible.builtin.stat:
        path: /etc/systemd/system/k3s.service
      register: k3s_server_svc

    - name: Install k3s server (runs local script)
      ansible.builtin.command:
        cmd: "{{ k3s_install_script }} server --write-kubeconfig-mode 644"
      environment:
        INSTALL_K3S_VERSION: "{{ k3s_version }}"
      when: not k3s_server_svc.stat.exists

    - name: Ensure k3s service is enabled and started
      ansible.builtin.systemd:
        name: k3s
        enabled: true
        state: started

    - name: Wait for server node-token to exist
      ansible.builtin.wait_for:
        path: /var/lib/rancher/k3s/server/node-token
        timeout: 120

    - name: Read cluster node-token (for agents)
      ansible.builtin.slurp:
        src: /var/lib/rancher/k3s/server/node-token
      register: node_token_raw

    - name: Set token fact (shared via hostvars)
      ansible.builtin.set_fact:
        k3s_node_token: "{{ node_token_raw.content | b64decode | trim }}"


- name: Install/ensure k3s agents
  hosts: agents
  become: true
  gather_facts: true

  vars:
    k3s_version: "v1.30.6+k3s1"
    k3s_install_script: /usr/local/src/k3s-install.sh

  pre_tasks:
    - name: Pick the server host from inventory
      ansible.builtin.set_fact:
        _server_host: "{{ groups['server'][0] }}"

    - name: Build K3S_URL from server ansible_host
      ansible.builtin.set_fact:
        k3s_url: "https://{{ hostvars[_server_host].ansible_host }}:6443"

    - name: Pull K3S_TOKEN from server hostvars
      ansible.builtin.set_fact:
        k3s_token: "{{ hostvars[_server_host].k3s_node_token }}"

  tasks:
    - name: Ensure install script directory exists
      ansible.builtin.file:
        path: /usr/local/src
        state: directory
        mode: "0755"

    - name: Download k3s install script (no curl|sh)
      ansible.builtin.get_url:
        url: https://get.k3s.io
        dest: "{{ k3s_install_script }}"
        mode: "0755"

    - name: Check if k3s-agent service exists
      ansible.builtin.stat:
        path: /etc/systemd/system/k3s-agent.service
      register: k3s_agent_svc

    - name: Install k3s agent (runs local script)
      ansible.builtin.command:
        cmd: "{{ k3s_install_script }} agent"
      environment:
        INSTALL_K3S_VERSION: "{{ k3s_version }}"
        K3S_URL: "{{ k3s_url }}"
        K3S_TOKEN: "{{ k3s_token }}"
      when: not k3s_agent_svc.stat.exists

    - name: Ensure k3s-agent service is enabled and started
      ansible.builtin.systemd:
        name: k3s-agent
        enabled: true
        state: started
